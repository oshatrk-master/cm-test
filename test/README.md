# Тесты

## Структура каталогов


* **test**
  * **e2e** — e2e тесты
    * **acceptance** — приемочные e2e тесты
    * **errorShots** — каталог для скриншотов ошибок (сами скриншоты исключены из контроля версий в .gitignore)
  * **integration** — интеграционные
    * **acceptance** — приемочные интеграционные тесты
  * **unit** — юнит-тесты
    * **acceptance** — приемочные юнит-тесты

Юнит-тесты — взаимодействуют только в пределах модуля 
нашего кода, при этом Sails.js не вызывается.

Интеграционные тесты — взаимодействуют с нашим модулем 
и каким-либо внешним кодом (Sails.js, базой данных, почтой 
и т.д.).

End-to-end (e2e) тесты — взаимодействуют со всем приложением через браузер
(используется Webdriver).

Любой тест может являтся приемочным,
т.е. тестирующим поведение, указанное в требованиях.
Такие тесты имеют повышенный приоритет, поэтому выделены
в каждой категории в отдельный каталог.

Команды тестирования выполняются из каталога приложения (там же где обычно выполняется команда `sails lift`):
* Запуск юнит- и интеграционных тестов:

  `npm test`

* Запуск только приемочных юнит- и интеграционных тестов:

  `npm -s run test-acceptance`

* Запуск e2e тестов:

  `npm -s run test-e2e`

  При этом, должно быть запущено само приложение
  
    `sails lift`
  
  и PhantomJS
  
    `phantomjs --webdriver=4444`

* Запуск только приемочных e2e тестов:

  `npm -s run test-e2e-acceptance`

  Приложение Sails и PhantomJS также должны быть запущены.

Для интеграционных и юнит-тестов используется [Mocha](https://mochajs.org).

Для e2e-тестов - [WebdriverIO](http://webdriver.io), настроенный для работы 
с Mocha и [PhantomJS](http://phantomjs.org/download.html)
(см. файлы настроек `./test/wdio.conf.js` и  `./test/wdio.conf-acceptance.js`).

Для интеграционных тестов Sails запускается на порту 1338,
чтобы не конфликтовать с портом 1337, на котором в это же время
может выполняться Sails для разработки или e2e-тестирования
(см. файлы настроек `./test/mocha-prepare.js` и  `./test/wdio.conf.js`).

Сейчас в качестве адаптера базы данных в интеграционных тестах
указан `sails-disk` (см. `./test/mocha-prepare.js`). 
Скорее всего, в дальнейшем, потребуется переключить на
Postgresql. И лучше будет сделать отдельную базу
для таких тестов, чтобы они не конфликтовали
с другим Sails (запущенным для разработки на 1337 порту).


Для e2e тестов понадобится установить библиотеку для разработки под PostgreSQL.
Установка для Debian/Ubuntu:

`sudo apt-get install libpq-dev`

Для других операционных систем см. инструкцию к 
[`pg-native`](https://github.com/brianc/node-pg-native).

## Запуск отдельных тестов

### Запуск отдельных e2e-тестов

Выполнить в разных терминалах три команды:

`sails lift`

`phantomjs --webdriver=4444`

`./node_modules/.bin/wdio test/wdio.conf.js --spec ./test/e2e/acceptance/email_activation.test.ts`

### Запуск отдельных интеграционных тестов

Так как запуск Sails для интеграционных тестов выполняется
с помощью пакета `mocha-prepare` (который устанавливается в `./node_modules` проекта),
то для запуска отдельного теста необходимо использовать `mocha` из `./node_modules`
проекта (также как это делает `npm`), а не установленный глобально, например:

`./node_modules/mocha/bin/mocha ./test/integration/acceptance/developer_name.test.ts`
